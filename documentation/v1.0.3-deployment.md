# v1.0.3 Deployment Guide

## Overview

This document outlines the deployment process for 1SLiquidity v1.0.3, including core protocol contracts and DEX integrations (UniswapV2, UniswapV3, Sushiswap, BalancerV2, and CurveMeta).

## Deployment Strategy

### Architecture

The deployment follows a modular approach:

1. **Core Protocol**: Deploy Executor, Registry, StreamDaemon, Core
2. **DEX Fetchers**: Deploy all DEX-specific fetchers and registries
3. **Post-Deployment Configuration**: Configure Balancer pools and UniswapV3 QuoterV2
4. **Address Extraction**: Export deployed addresses to versions file

### CREATE2 Deployment

- Uses deterministic address generation for predictable deployment addresses
- Some contracts cannot be deployed and then configured by admin if deployed via CREATE2
- Requires careful ordering of deployment steps

## Deployment Process

### Step 1: Dry Run Validation

```bash
npm run deploy:barebones:dry-run
```

**Purpose**: Validate deployment script without broadcasting transactions
**Requirements**:

- Fork URL for simulation
- No private key required (uses default anvil key)
- Validates all contract deployments and configurations

### Step 2: Core Protocol Deployment

```bash
npm run deploy:barebones:create2
```

**Purpose**: Deploy core protocol contracts using CREATE2
**Deploys**:

- Executor
- Registry
- StreamDaemon
- Core
- UniswapV2Fetcher
- UniswapV3Fetcher (3 instances for different fee tiers)
- SushiswapFetcher
- BalancerV2PoolRegistry
- BalancerV2Fetcher
- CurveMetaFetcher

**Configuration**:

- Essential Balancer pools (USDC/WETH, BAL/WETH)
- QuoterV2 for all UniswapV3 fetchers
- DEX type registration in Registry

### Step 3: Balancer Pool Population

```bash
npm run deploy:balancer:setup-pools
```

**Purpose**: Populate BalancerV2PoolRegistry with comprehensive pool list
**Note**: Run separately after core deployment for full pool initialization

### Step 4: Address Extraction

```bash
npm run deploy:versions:export
```

**Purpose**: Extract deployed contract addresses to versions file
**Output**: Contract addresses for frontend integration

### Complete Deployment Command

```bash
npm run deploy:barebones:create2:complete
```

**Purpose**: Execute all deployment steps in sequence
**Includes**: Core deploy → Balancer setup → Address export

## Risks and Constraints

### Critical Risks

1. **CREATE2 Address Collision**: Ensure unique salt values to prevent address conflicts
2. **Admin Configuration**: Some contracts deployed via CREATE2 cannot be reconfigured by admin
3. **Balancer Pool Dependencies**: BalancerV2Fetcher requires populated registry for full functionality
4. **QuoterV2 Configuration**: UniswapV3 fetchers must be configured with QuoterV2 addresses

### Constraints

1. **Deployment Order**: Core contracts must be deployed before DEX integrations
2. **Registry Dependencies**: All DEX types must be registered in Registry before StreamDaemon deployment
3. **Fork Requirements**: Dry run requires mainnet fork for accurate simulation
4. **Gas Limits**: Large deployment may require gas limit adjustments

### Mitigation Strategies

1. **Dry Run Validation**: Always run dry run before mainnet deployment
2. **Modular Deployment**: Separate core deployment from configuration steps
3. **Comprehensive Testing**: Full test suite validation before deployment
4. **Address Verification**: Confirm all addresses are correctly configured

## Dry Run Results

### Actual Output (Validated)

✅ **All contract deployments successful**

- Executor deployed at: 0x961e384b66ae2Bb90c9bBdd3d5105397E70a7A37
- Registry deployed at: 0x5aAdFB43eF8dAF45DD80F4676345b7676f1D70e3
- StreamDaemon deployed at: 0xcD95e0E356A5f414894Be4bAD363acdaCcAb30a9
- Core deployed at: 0xC33F7eF76C2bBC678794516f038e62Ce3fAE6072

✅ **DEX fetchers deployed and configured**

- UniswapV2Fetcher: 0xed0ffa5201994cac3e17566f445c5d0d0103f016
- UniswapV3Fetcher (0.05%): 0x1cc0f57abc6a1cc511d1afaf7cb6e45b6dc4ea2f
- UniswapV3Fetcher (0.3%): 0xa1ac6c241b9fc3aa5c9eee4eb2232dddee3c109a
- UniswapV3Fetcher (1%): 0x19d25f286b8dca21886bcbe9c21334c6f0c532fb
- SushiswapFetcher: 0xf7adf0f8bcb9e8f4fc843974b519591de3e48b08
- BalancerV2PoolRegistry: 0x83303d67770f7e28f9f10fd5612fee7952eff10c
- BalancerV2Fetcher: 0xef66a61f4fd0000355d2dbf6c62fa23bcc003ec6
- CurveMetaFetcher: 0xfd121994a2249d0a93b7daed70b4fc990e9a8455

✅ **DEX type registration completed**

- All DEX types registered in Registry
- StreamDaemon initialized with all fetchers and routers

✅ **Essential Balancer pools added**

- USDC/WETH pool: 0x96646936b91d6B9D7D0c47C496AfBF3D6ec7B6f8
- BAL/WETH pool: 0x5c6Ee304399DBdB9C8Ef030aB642B10820DB8F56

✅ **QuoterV2 configuration successful**

- All 3 UniswapV3Fetcher instances configured with QuoterV2: 0x61fFE014bA17989E743c5F6cB21bF9697530B21e

✅ **No critical errors or reverts**

- All transactions simulated successfully
- Gas estimates within reasonable limits
- No deployment failures

### Validation Checklist

- [x] Executor deployed and configured
- [x] Registry deployed with all DEX types
- [x] StreamDaemon deployed with all fetchers
- [x] Core deployed and linked to all components
- [x] All DEX fetchers deployed and configured
- [x] BalancerV2PoolRegistry populated with essential pools
- [x] QuoterV2 configured for all UniswapV3 fetchers
- [x] No deployment errors or reverts

## Post-Deployment Verification

### Contract Verification

1. Verify all contracts on Etherscan
2. Confirm contract addresses match expected values
3. Validate DEX type registration in Registry
4. Test basic functionality of each DEX integration

### Integration Testing

1. Run full test suite against deployed contracts
2. Validate reserve reading for all DEXs
3. Test trade placement and execution
4. Confirm fee collection and distribution

## Commands Reference

### Development/Testing

```bash
# Run full test suite
npm run test:all:anvil

# Test specific DEX reserves
npm run test:balancer-reserves-anvil
npm run test:curve-reserves-anvil

# Test trade placement
npm run test:balancer-trade-anvil
npm run test:curve-trade-anvil
```

### Deployment

```bash
# Dry run (simulation only)
npm run deploy:barebones:dry-run

# Core deployment
npm run deploy:barebones:create2

# Balancer pool setup
npm run deploy:balancer:setup-pools

# Address extraction
npm run deploy:versions:export

# Complete deployment
npm run deploy:barebones:create2:complete
```

## Security Considerations

### Private Key Management

- Use encrypted private keys with `cast` for production
- Never commit private keys to repository
- Use environment variables for sensitive data

### Contract Verification

- Verify all contracts on Etherscan
- Use deterministic deployment for address verification
- Validate all contract interactions before mainnet deployment

### Access Control

- Confirm admin roles are properly configured
- Validate keeper permissions for BalancerV2PoolRegistry
- Ensure proper access control for all deployed contracts

## Troubleshooting

### Common Issues

1. **"NOT_OWNER" errors**: Check keeper permissions in BalancerV2PoolRegistry
2. **Address mismatch**: Verify CREATE2 salt values and deployment order
3. **Configuration failures**: Ensure all dependencies are deployed before configuration
4. **Gas limit exceeded**: Increase gas limits for large deployments

### Recovery Procedures

1. **Failed deployment**: Use dry run to identify issues before retry
2. **Configuration errors**: Redeploy affected contracts with correct parameters
3. **Address conflicts**: Use different salt values for CREATE2 deployment

## Conclusion

The v1.0.3 deployment process is designed to be robust and verifiable. Always run the dry run first, follow the deployment order, and validate each step before proceeding to the next. The modular approach allows for easier troubleshooting and recovery if issues arise during deployment.
