#!/bin/bash

# Test WETH pairs with chunking
# Usage: ./test-weth [chunk-size] [output-file]

CHUNK_SIZE=${1:-10}
OUTPUT_FILE=${2:-"test-results-weth-$(date +%Y%m%d_%H%M%S).json"}

echo "ğŸ§ª Running WETH trade tests..."
echo "ğŸ“¦ Chunk size: $CHUNK_SIZE tokens"
echo "ğŸ“ Output: $OUTPUT_FILE"
echo ""

# Get pair count
WETH_COUNT=$(jq '.totalCount' config/weth_pairs_clean.json)
NUM_CHUNKS=$(( (WETH_COUNT + CHUNK_SIZE - 1) / CHUNK_SIZE ))

echo "ğŸ“Š WETH: $WETH_COUNT pairs â†’ $NUM_CHUNKS chunks"
echo ""

# Temporary file for logs
TEMP_LOG=$(mktemp)

# Run chunks
for ((chunk=0; chunk<NUM_CHUNKS; chunk++)); do
    start=$((chunk * CHUNK_SIZE))
    end=$((start + CHUNK_SIZE))
    if [ $end -gt $WETH_COUNT ]; then
        end=$WETH_COUNT
    fi
    
    echo "   Chunk $((chunk+1))/$NUM_CHUNKS: tokens $start-$end"
    START_INDEX=$start END_INDEX=$end forge test --match-test "test_PlaceTradeWithWETHTokens" -vv 2>&1 | tee -a "$TEMP_LOG"
done

echo ""
echo "ğŸ“Š Extracting results..."
bash ./scripts/extract-events-to-json.sh "$OUTPUT_FILE" < "$TEMP_LOG"

# Cleanup
rm -f "$TEMP_LOG"

echo "âœ… WETH tests completed!"